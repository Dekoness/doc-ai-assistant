<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Portfolio Azure AI</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <h1>üöÄ Portfolio Azure AI</h1>
      <p class="subtitle">
        Computer Vision OCR + GPT-4.1-mini | Azure Services
      </p>

      <div class="sections">
        <!-- SECCI√ìN 1: ANALIZAR IMAGEN -->
        <div class="card">
          <h2>üì∑ Computer Vision OCR</h2>
          <p>
            Sube una imagen para extraer texto usando Azure Computer Vision.
          </p>
          <p>
            <small
              >Servicio: <strong>F0 Gratis</strong> (5,000 consultas/mes)</small
            >
          </p>

          <form id="imageForm">
            <input type="file" id="imageInput" accept="image/*" required />
            <button type="submit">üîç Extraer Texto</button>
          </form>

          <div id="imageResult" class="result"></div>

          <div id="textAnalysisSection" style="display: none; margin-top: 20px">
            <h3>ü§ñ Analizar texto con GPT</h3>
            <button id="analyzeTextBtn" onclick="analyzeWithGPT()">
              üìä Analizar texto extra√≠do
            </button>
            <div id="analysisResult" class="result"></div>
          </div>
        </div>

        <!-- SECCI√ìN 2: CHAT CON GPT -->
        <div class="card">
          <h2>üí¨ Azure OpenAI GPT-4.1-mini</h2>
          <p>Conversa con el modelo de lenguaje de Azure.</p>
          <p>
            <small>Costo: <strong>~$0.83/mes + tokens</strong></small>
          </p>

          <form id="chatForm">
            <textarea
              id="messageInput"
              placeholder="Escribe tu pregunta..."
              rows="3"
            ></textarea>
            <button type="submit">üì§ Enviar a GPT</button>
          </form>

          <div id="chatResult" class="result"></div>
        </div>
      </div>

      <!-- INFO Y COSTOS -->
      <div class="info">
        <h3>üîß Servicios Azure Utilizados:</h3>
        <div class="services-grid">
          <div class="service-card">
            <h4>üëÅÔ∏è Computer Vision</h4>
            <p>OCR y an√°lisis de im√°genes</p>
            <span class="free-badge">GRATIS</span>
          </div>
          <div class="service-card">
            <h4>ü§ñ Azure OpenAI</h4>
            <p>GPT-4.1-mini</p>
            <span class="cost-badge">~$0.83/mes</span>
          </div>
          <div class="service-card">
            <h4>üé§ Speech Service</h4>
            <p>Texto-a-voz / voz-a-texto</p>
            <span class="free-badge">GRATIS</span>
          </div>
        </div>

        <div class="cost-warning">
          <strong>üí∞ Costo total estimado:</strong> Menos de $5/mes con uso
          moderado
          <br />
          <small>Presupuesto configurado en Azure Portal con alertas</small>
        </div>
      </div>

      <!-- LOGS -->
      <div class="logs">
        <h3>üìä Estado del Sistema</h3>
        <div id="statusLogs"></div>
      </div>
    </div>

    <script>
      let conversationHistory = [];

      function showResult(elementId, content, isError = false) {
        const element = document.getElementById(elementId);
        element.innerHTML = `<div class="${
          isError ? "error" : "success"
        }">${content}</div>`;
      }

      function logStatus(message, type = "info") {
        const logs = document.getElementById("statusLogs");
        const time = new Date().toLocaleTimeString();
        const logEntry = `<div class="log-${type}">[${time}] ${message}</div>`;
        logs.innerHTML = logEntry + logs.innerHTML;
      }

      // 1. Formulario de imagen (OCR + Chat unificado)
      document
        .getElementById("imageForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const fileInput = document.getElementById("imageInput");

          if (!fileInput.files[0]) {
            showResult("imageResult", "‚ùå Selecciona una imagen primero", true);
            return;
          }

          showResult("imageResult", "‚è≥ Procesando imagen...");
          logStatus("Enviando imagen al agente...");

          const reader = new FileReader();
          reader.onloadend = async function () {
            try {
              const response = await fetch("/api/agent", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  message: "Analiza esta imagen y dime qu√© texto contiene",
                  image: reader.result,
                  history: conversationHistory,
                }),
              });

              const responseText = await response.text();
              console.log("Agent Response:", responseText);

              if (!response.ok) {
                throw new Error(`Error ${response.status}: ${responseText}`);
              }

              const result = JSON.parse(responseText);

              if (result.success) {
                conversationHistory = result.history_updated;

                showResult(
                  "imageResult",
                  `‚úÖ <strong>Texto extra√≠do:</strong><br><pre>${
                    result.extracted_text || "Sin texto"
                  }</pre>
             <br><strong>An√°lisis GPT:</strong><br>${result.reply}`
                );

                logStatus(`OCR + GPT completado`);
              } else {
                showResult("imageResult", `‚ùå Error: ${result.error}`, true);
                logStatus(`Error: ${result.error}`, "error");
              }
            } catch (error) {
              console.error("Error:", error);
              showResult("imageResult", `‚ùå Error: ${error.message}`, true);
              logStatus(`Error: ${error.message}`, "error");
            }
          };
          reader.readAsDataURL(fileInput.files[0]);
        });

      // 2. Chat de texto
      document
        .getElementById("chatForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const message = document.getElementById("messageInput").value.trim();

          if (!message) {
            showResult("chatResult", "‚ùå Escribe un mensaje", true);
            return;
          }

          showResult("chatResult", "‚è≥ GPT pensando...");
          logStatus(`Enviando: "${message.substring(0, 50)}..."`);

          try {
            const response = await fetch("/api/agent", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                message: message,
                history: conversationHistory,
              }),
            });

            const responseText = await response.text();
            console.log("Agent Response:", responseText);

            if (!response.ok) {
              throw new Error(`Error ${response.status}: ${responseText}`);
            }

            const result = JSON.parse(responseText);

            if (result.success) {
              conversationHistory = result.history_updated;

              showResult(
                "chatResult",
                `‚úÖ <strong>GPT responde:</strong><br>${result.reply}`
              );

              logStatus(`GPT respondi√≥`);
              document.getElementById("messageInput").value = "";
            } else {
              showResult("chatResult", `‚ùå Error: ${result.error}`, true);
              logStatus(`Error: ${result.error}`, "error");
            }
          } catch (error) {
            console.error("Error:", error);
            showResult("chatResult", `‚ùå Error: ${error.message}`, true);
            logStatus(`Error: ${error.message}`, "error");
          }
        });

      logStatus("Aplicaci√≥n cargada");
    </script>
  </body>
</html>
