<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Portfolio Azure AI</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <h1>üöÄ Portfolio Azure AI</h1>
      <p class="subtitle">
        Computer Vision OCR + GPT-4.1-mini | Azure Services
      </p>

      <div class="sections">
        <!-- SECCI√ìN 1: ANALIZAR IMAGEN -->
        <div class="card">
          <h2>üì∑ Computer Vision OCR</h2>
          <p>
            Sube una imagen para extraer texto usando Azure Computer Vision.
          </p>
          <p>
            <small
              >Servicio: <strong>F0 Gratis</strong> (5,000 consultas/mes)</small
            >
          </p>

          <form id="imageForm">
            <input type="file" id="imageInput" accept="image/*" required />
            <button type="submit">üîç Extraer Texto</button>
          </form>

          <div id="imageResult" class="result"></div>

          <div id="textAnalysisSection" style="display: none; margin-top: 20px">
            <h3>ü§ñ Analizar texto con GPT</h3>
            <button id="analyzeTextBtn" onclick="analyzeWithGPT()">
              üìä Analizar texto extra√≠do
            </button>
            <div id="analysisResult" class="result"></div>
          </div>
        </div>

        <!-- SECCI√ìN 2: CHAT CON GPT -->
        <div class="card">
          <h2>üí¨ Azure OpenAI GPT-4.1-mini</h2>
          <p>Conversa con el modelo de lenguaje de Azure.</p>
          <p>
            <small>Costo: <strong>~$0.83/mes + tokens</strong></small>
          </p>

          <form id="chatForm">
            <textarea
              id="messageInput"
              placeholder="Escribe tu pregunta..."
              rows="3"
            ></textarea>
            <button type="submit">üì§ Enviar a GPT</button>
          </form>

          <div id="chatResult" class="result"></div>
        </div>
      </div>

      <!-- INFO Y COSTOS -->
      <div class="info">
        <h3>üîß Servicios Azure Utilizados:</h3>
        <div class="services-grid">
          <div class="service-card">
            <h4>üëÅÔ∏è Computer Vision</h4>
            <p>OCR y an√°lisis de im√°genes</p>
            <span class="free-badge">GRATIS</span>
          </div>
          <div class="service-card">
            <h4>ü§ñ Azure OpenAI</h4>
            <p>GPT-4.1-mini</p>
            <span class="cost-badge">~$0.83/mes</span>
          </div>
          <div class="service-card">
            <h4>üé§ Speech Service</h4>
            <p>Texto-a-voz / voz-a-texto</p>
            <span class="free-badge">GRATIS</span>
          </div>
        </div>

        <div class="cost-warning">
          <strong>üí∞ Costo total estimado:</strong> Menos de $5/mes con uso
          moderado
          <br />
          <small>Presupuesto configurado en Azure Portal con alertas</small>
        </div>
      </div>

      <!-- LOGS -->
      <div class="logs">
        <h3>üìä Estado del Sistema</h3>
        <div id="statusLogs"></div>
      </div>
    </div>

    <script>
      let lastExtractedText = "";

      // Funci√≥n para mostrar resultados
      function showResult(elementId, content, isError = false) {
        const element = document.getElementById(elementId);
        element.innerHTML = `<div class="${
          isError ? "error" : "success"
        }">${content}</div>`;
      }

      // Funci√≥n para log
      function logStatus(message, type = "info") {
        const logs = document.getElementById("statusLogs");
        const time = new Date().toLocaleTimeString();
        const logEntry = `<div class="log-${type}">[${time}] ${message}</div>`;
        logs.innerHTML = logEntry + logs.innerHTML;
      }

      // 1. Formulario de imagen (OCR)
      document
        .getElementById("imageForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const fileInput = document.getElementById("imageInput");

          if (!fileInput.files[0]) {
            showResult("imageResult", "‚ùå Selecciona una imagen primero", true);
            return;
          }

          showResult("imageResult", "‚è≥ Enviando a Azure Computer Vision...");
          logStatus("Iniciando an√°lisis de imagen...");

          const formData = new FormData();
          formData.append("image", fileInput.files[0]);

          try {
            const response = await fetch("/api/analyze-image", {
              method: "POST",
              body: formData,
            });

            const result = await response.json();

            if (result.success) {
              lastExtractedText = result.extracted_text;

              let displayText = result.extracted_text;
              if (!displayText) {
                displayText = "‚ö†Ô∏è No se encontr√≥ texto en la imagen";
              }

              showResult(
                "imageResult",
                `‚úÖ <strong>Texto extra√≠do:</strong><br><pre>${displayText}</pre>`
              );

              logStatus(
                `OCR completado: ${result.extracted_text.length} caracteres extra√≠dos`
              );

              // Mostrar secci√≥n de an√°lisis GPT
              if (result.extracted_text) {
                document.getElementById("textAnalysisSection").style.display =
                  "block";
              }
            } else {
              showResult("imageResult", `‚ùå Error: ${result.error}`, true);
              logStatus(`Error en OCR: ${result.error}`, "error");
            }
          } catch (error) {
            showResult("imageResult", `‚ùå Error de conexi√≥n: ${error}`, true);
            logStatus(`Error de red: ${error}`, "error");
          }
        });

      // 2. Analizar texto con GPT
      window.analyzeWithGPT = async function () {
        if (!lastExtractedText) {
          showResult("analysisResult", "‚ùå No hay texto para analizar", true);
          return;
        }

        showResult(
          "analysisResult",
          "‚è≥ Enviando a GPT-4.1-mini para an√°lisis..."
        );
        logStatus("Enviando texto extra√≠do a GPT para an√°lisis...");

        try {
          const response = await fetch("/api/analyze-extracted-text", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text: lastExtractedText }),
          });

          const result = await response.json();

          if (result.success) {
            showResult(
              "analysisResult",
              `‚úÖ <strong>An√°lisis GPT:</strong><br>${result.analysis}<br>
                         <small>Texto original: ${result.original_text}</small>`
            );

            logStatus(`An√°lisis GPT completado`);
          } else {
            showResult("analysisResult", `‚ùå Error: ${result.error}`, true);
            logStatus(`Error en GPT: ${result.error}`, "error");
          }
        } catch (error) {
          showResult("analysisResult", `‚ùå Error: ${error}`, true);
          logStatus(`Error de red: ${error}`, "error");
        }
      };

      // 3. Formulario de chat
      document
        .getElementById("chatForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const message = document.getElementById("messageInput").value.trim();

          if (!message) {
            showResult("chatResult", "‚ùå Escribe un mensaje primero", true);
            return;
          }

          showResult("chatResult", "‚è≥ GPT-4.1-mini pensando...");
          logStatus(`Enviando mensaje a GPT: "${message.substring(0, 50)}..."`);

          try {
            const responseText = await response.text();
            console.log("RAW RESPONSE:", responseText);
            console.log("STATUS:", response.status);
            console.log("HEADERS:", response.headers);

            try {
              const result = JSON.parse(responseText);
              // Procesar result normalmente
            } catch (e) {
              console.error("JSON PARSE ERROR:", e);
              showResult(
                "chatResult",
                `‚ùå Error: La respuesta no es JSON. Servidor dice: ${responseText.substring(
                  0,
                  200
                )}`,
                true
              );
            }

            if (result.success) {
              const tokens = result.tokens_used || {};
              showResult(
                "chatResult",
                `‚úÖ <strong>GPT responde:</strong><br>${result.reply}<br>
                         <small>Tokens: ${
                           tokens.prompt_tokens || "?"
                         } entrada, ${
                  tokens.completion_tokens || "?"
                } salida</small>`
              );

              logStatus(`GPT respondi√≥ (${tokens.total_tokens || "?"} tokens)`);
            } else {
              showResult("chatResult", `‚ùå Error: ${result.error}`, true);
              logStatus(`Error GPT: ${result.error}`, "error");
            }
          } catch (error) {
            showResult("chatResult", `‚ùå Error de conexi√≥n: ${error}`, true);
            logStatus(`Error de red: ${error}`, "error");
          }
        });

      // Inicializaci√≥n
      logStatus("Aplicaci√≥n cargada y lista");
      console.log("Portfolio Azure AI - Frontend cargado");
    </script>
  </body>
</html>
