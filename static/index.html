<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Portfolio Azure AI</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="container">
      <h1>ğŸš€ Portfolio Azure AI</h1>
      <p class="subtitle">
        Computer Vision OCR + GPT-4.1-mini | Chat Unificado
      </p>

      <!-- CHAT UNIFICADO -->
      <div class="card chat-card">
        <h2>ğŸ’¬ Chat con VisiÃ³n + GPT-4.1-mini</h2>
        <p>Escribe mensajes o sube imÃ¡genes para anÃ¡lisis con OCR y GPT</p>

        <!-- Historial de conversaciÃ³n -->
        <div id="chatHistory" class="chat-history"></div>

        <!-- Formulario de entrada -->
        <form id="chatForm" class="chat-input-form">
          <div class="input-group">
            <label for="imageInput" class="file-label">
              ğŸ“ Adjuntar imagen (opcional)
            </label>
            <input
              type="file"
              id="imageInput"
              accept="image/*"
              style="display: none"
            />
            <span id="fileName" class="file-name"></span>
          </div>

          <textarea
            id="messageInput"
            placeholder="Escribe tu mensaje... (puedes adjuntar una imagen)"
            rows="3"
            required
          ></textarea>

          <button type="submit" id="sendBtn">ğŸ“¤ Enviar</button>
        </form>
      </div>

      <!-- INFO Y COSTOS -->
      <div class="info">
        <h3>ğŸ”§ Servicios Azure Utilizados:</h3>
        <div class="services-grid">
          <div class="service-card">
            <h4>ğŸ‘ï¸ Computer Vision</h4>
            <p>OCR automÃ¡tico en imÃ¡genes</p>
            <span class="free-badge">GRATIS</span>
          </div>
          <div class="service-card">
            <h4>ğŸ¤– Azure OpenAI</h4>
            <p>GPT-4.1-mini con contexto</p>
            <span class="cost-badge">~$0.83/mes</span>
          </div>
          <div class="service-card">
            <h4>ğŸŒ Static Web Apps</h4>
            <p>Hosting + Azure Functions</p>
            <span class="free-badge">GRATIS</span>
          </div>
        </div>

        <div class="cost-warning">
          <strong>ğŸ’° Costo total estimado:</strong> Menos de $5/mes con uso
          moderado
          <br />
          <small>Presupuesto configurado en Azure Portal con alertas</small>
        </div>
      </div>

      <!-- LOGS -->
      <div class="logs">
        <h3>ğŸ“Š Estado del Sistema</h3>
        <div id="statusLogs"></div>
      </div>
    </div>

    <script>
      let conversationHistory = [];
      let selectedFile = null;

      function logStatus(message, type = "info") {
        const logs = document.getElementById("statusLogs");
        const time = new Date().toLocaleTimeString();
        const logEntry = `<div class="log-${type}">[${time}] ${message}</div>`;
        logs.innerHTML = logEntry + logs.innerHTML;
      }

      function addMessageToChat(role, content, hasImage = false) {
        const chatHistory = document.getElementById("chatHistory");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${role}`;

        const icon = role === "user" ? "ğŸ‘¤" : "ğŸ¤–";
        const label = role === "user" ? "TÃº" : "Asistente";
        const imageTag = hasImage
          ? '<span class="image-tag">ğŸ“· Imagen adjunta</span>'
          : "";

        messageDiv.innerHTML = `
          <div class="message-header">
            <strong>${icon} ${label}</strong>
            <span class="timestamp">${new Date().toLocaleTimeString()}</span>
          </div>
          ${imageTag}
          <div class="message-content">${content.replace(/\n/g, "<br>")}</div>
        `;

        chatHistory.appendChild(messageDiv);
        chatHistory.scrollTop = chatHistory.scrollHeight;
      }

      // Manejar selecciÃ³n de archivo
      document.getElementById("imageInput").addEventListener("change", (e) => {
        const file = e.target.files[0];
        const fileNameSpan = document.getElementById("fileName");

        if (file) {
          selectedFile = file;
          fileNameSpan.textContent = `ğŸ“· ${file.name}`;
          fileNameSpan.style.display = "inline";
        } else {
          selectedFile = null;
          fileNameSpan.textContent = "";
          fileNameSpan.style.display = "none";
        }
      });

      // Click en label para abrir selector de archivos
      document.querySelector(".file-label").addEventListener("click", () => {
        document.getElementById("imageInput").click();
      });

      // Enviar mensaje
      document
        .getElementById("chatForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const messageInput = document.getElementById("messageInput");
          const message = messageInput.value.trim();
          const sendBtn = document.getElementById("sendBtn");

          if (!message) return;

          // Deshabilitar botÃ³n
          sendBtn.disabled = true;
          sendBtn.textContent = "â³ Enviando...";

          // Mostrar mensaje del usuario
          addMessageToChat("user", message, !!selectedFile);
          logStatus(`Enviando: "${message.substring(0, 50)}..."`);

          try {
            let imageBase64 = null;

            // Si hay imagen, convertir a base64
            if (selectedFile) {
              imageBase64 = await new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(selectedFile);
              });
            }

            // Llamar a la API
            const response = await fetch("/api/agent", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                message: message,
                image: imageBase64,
                history: conversationHistory,
              }),
            });

            const responseText = await response.text();
            console.log("Agent Response:", responseText);

            if (!response.ok) {
              throw new Error(`Error ${response.status}: ${responseText}`);
            }

            const result = JSON.parse(responseText);

            if (result.success) {
              conversationHistory = result.history_updated;

              // Mostrar texto extraÃ­do si hay imagen
              let assistantMessage = result.reply;
              if (result.extracted_text) {
                assistantMessage = `ğŸ“„ <strong>Texto detectado:</strong>\n${result.extracted_text}\n\n${result.reply}`;
              }

              addMessageToChat("assistant", assistantMessage);
              logStatus(`Respuesta recibida`);

              // Limpiar formulario
              messageInput.value = "";
              selectedFile = null;
              document.getElementById("fileName").textContent = "";
              document.getElementById("fileName").style.display = "none";
              document.getElementById("imageInput").value = "";
            } else {
              throw new Error(result.error || "Error desconocido");
            }
          } catch (error) {
            console.error("Error:", error);
            addMessageToChat("assistant", `âŒ Error: ${error.message}`);
            logStatus(`Error: ${error.message}`, "error");
          } finally {
            sendBtn.disabled = false;
            sendBtn.textContent = "ğŸ“¤ Enviar";
          }
        });

      logStatus("AplicaciÃ³n cargada correctamente");
    </script>
  </body>
</html>
