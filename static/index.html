<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Federico Zoppi - Azure AI Assistant</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="background-gradient"></div>

    <div class="container">
      <header class="header-glass">
        <div class="header-content">
          <div>
            <h1>Azure AI Assistant</h1>
            <p class="subtitle">RAG ‚Ä¢ Computer Vision ‚Ä¢ GPT-4o-mini</p>
          </div>
          <div class="header-actions">
            <a
              href="https://storagefedericokb.blob.core.windows.net/certificados-federico/CV%20-%20Federico%20Zoppi.pdf?sp=r&st=2026-02-05T15:58:05Z&se=2027-02-02T00:13:05Z&spr=https&sv=2024-11-04&sr=b&sig=cQ8VXG0i1pKgGSnwpqzBMH7XeKOnTNSbB3S8EDFqeLc%3D"
              target="_blank"
              class="cv-download-btn"
              aria-label="Descargar CV"
            >
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="7 10 12 15 17 10" />
                <line x1="12" y1="15" x2="12" y2="3" />
              </svg>
              <span>Descargar CV</span>
            </a>
            <button
              id="themeToggle"
              class="theme-toggle"
              aria-label="Cambiar tema"
            >
              <svg
                class="sun-icon"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <circle cx="12" cy="12" r="5" />
                <line x1="12" y1="1" x2="12" y2="3" />
                <line x1="12" y1="21" x2="12" y2="23" />
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64" />
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78" />
                <line x1="1" y1="12" x2="3" y2="12" />
                <line x1="21" y1="12" x2="23" y2="12" />
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36" />
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22" />
              </svg>
              <svg
                class="moon-icon"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
              </svg>
            </button>
          </div>
        </div>
        <div class="agent-description">
          <p>
            üëã ¬°Hola! Soy el asistente virtual de Federico Zoppi. Mi funci√≥n es
            presentarlo al mundo profesional de la tecnolog√≠a.
            <strong>Pregunta "¬øQui√©n es Federico Zoppi?"</strong> para conocer
            su experiencia, certificaciones y proyectos.
          </p>
        </div>
      </header>

      <!-- CHAT PRINCIPAL -->
      <div class="chat-container glass">
        <div class="chat-header">
          <div class="status-indicator">
            <span class="status-dot"></span>
            <span>En l√≠nea</span>
          </div>
          <div class="stats-mini">
            <span id="messageCount">0 mensajes</span>
          </div>
        </div>

        <!-- Historial de conversaci√≥n -->
        <div id="chatHistory" class="chat-history"></div>

        <!-- Formulario de entrada -->
        <form id="chatForm" class="chat-input-container">
          <div class="input-wrapper">
            <!-- Preview de imagen -->
            <div id="imagePreview" class="image-preview" style="display: none">
              <img id="previewImg" src="" alt="Preview" />
              <button type="button" id="removeImage" class="remove-image-btn">
                ‚úï
              </button>
            </div>

            <!-- √Årea de texto -->
            <textarea
              id="messageInput"
              placeholder="Escribe tu mensaje o adjunta una imagen..."
              rows="1"
            ></textarea>

            <!-- Botones de acci√≥n -->
            <div class="input-actions">
              <label
                for="imageInput"
                class="attach-btn"
                title="Adjuntar imagen"
              >
                <svg
                  width="20"
                  height="20"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"
                  />
                </svg>
              </label>
              <input
                type="file"
                id="imageInput"
                accept="image/*"
                style="display: none"
              />

              <button
                type="submit"
                id="sendBtn"
                class="send-btn"
                title="Enviar"
              >
                <span class="send-icon">
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" />
                  </svg>
                </span>
              </button>
            </div>
          </div>
        </form>
      </div>

      <!-- ESTAD√çSTICAS -->
      <div class="stats-container">
        <div class="stat-card glass">
          <div class="stat-icon-text">MSG</div>
          <div class="stat-info">
            <span class="stat-value" id="totalMessages">0</span>
            <span class="stat-label">Mensajes</span>
          </div>
        </div>

        <div class="stat-card glass">
          <div class="stat-icon-text">IMG</div>
          <div class="stat-info">
            <span class="stat-value" id="totalImages">0</span>
            <span class="stat-label">Im√°genes</span>
          </div>
        </div>

        <div class="stat-card glass">
          <div class="stat-icon-text">TKN</div>
          <div class="stat-info">
            <span class="stat-value" id="totalTokens">0</span>
            <span class="stat-label">Tokens</span>
          </div>
        </div>

        <div class="stat-card glass">
          <div class="stat-icon-text">MS</div>
          <div class="stat-info">
            <span class="stat-value" id="avgResponseTime">0ms</span>
            <span class="stat-label">Latencia</span>
          </div>
        </div>
      </div>

      <!-- INFO DE SERVICIOS -->
      <div class="services-info glass">
        <h3>Servicios Azure Implementados</h3>
        <div class="services-grid">
          <div class="service-badge">
            <span class="service-name">Computer Vision</span>
            <span class="badge-tier">Free Tier</span>
            <span class="badge-cost">$0.00/mes</span>
          </div>
          <div class="service-badge">
            <span class="service-name">Azure OpenAI (GPT-4o-mini)</span>
            <span class="badge-tier">Pay-as-you-go</span>
            <span class="badge-cost">~$0.50/mes</span>
          </div>
          <div class="service-badge">
            <span class="service-name">AI Search</span>
            <span class="badge-tier">Free Tier</span>
            <span class="badge-cost">$0.00/mes</span>
          </div>
          <div class="service-badge">
            <span class="service-name">Static Web Apps</span>
            <span class="badge-tier">Free Tier</span>
            <span class="badge-cost">$0.00/mes</span>
          </div>
          <div class="service-badge">
            <span class="service-name">Blob Storage</span>
            <span class="badge-tier">Standard LRS</span>
            <span class="badge-cost">~$0.02/mes</span>
          </div>
          <div class="service-badge">
            <span class="service-name">Azure Functions</span>
            <span class="badge-tier">Consumption</span>
            <span class="badge-cost">~$0.05/mes</span>
          </div>
        </div>
      </div>

      <!-- USO RESPONSABLE -->
      <div class="usage-info glass">
        <h3>üí° Uso Responsable</h3>
        <p class="usage-description">
          ¬°Hey! Este asistente funciona con servicios cloud que generan costos
          seg√∫n el uso. Un uso moderado me ayuda a mantener el proyecto
          accesible. üòä
        </p>
        <div class="usage-examples">
          <div class="usage-example">
            <span class="example-emoji">üí¨</span>
            <div>
              <strong>Conversaci√≥n est√°ndar</strong>
              <p>10-15 mensajes al d√≠a ‚âà $0.015/d√≠a</p>
            </div>
          </div>
          <div class="usage-example">
            <span class="example-emoji">üì∑</span>
            <div>
              <strong>An√°lisis de im√°genes</strong>
              <p>5 im√°genes al d√≠a ‚âà $0.00/d√≠a (Free Tier)</p>
            </div>
          </div>
          <div class="usage-example">
            <span class="example-emoji">üîç</span>
            <div>
              <strong>Consultas RAG</strong>
              <p>20 b√∫squedas al d√≠a ‚âà $0.00/d√≠a (Free Tier)</p>
            </div>
          </div>
        </div>
        <p class="usage-footer">
          <strong>Resumen:</strong> Un uso normal (20-30 interacciones diarias)
          supone aproximadamente <strong>$0.50-1.00/mes</strong>. ¬°√ösalo con
          confianza pero conscientemente! üöÄ
        </p>
      </div>
    </div>

    <script>
      // Theme Toggle
      const themeToggle = document.getElementById("themeToggle");
      const body = document.body;

      // Check for saved theme preference or default to 'dark'
      const currentTheme = localStorage.getItem("theme") || "dark";
      body.setAttribute("data-theme", currentTheme);

      themeToggle.addEventListener("click", function () {
        const currentTheme = body.getAttribute("data-theme");
        const newTheme = currentTheme === "dark" ? "light" : "dark";
        body.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
      });

      let conversationHistory = [];
      let selectedFile = null;
      let stats = {
        messages: 0,
        images: 0,
        tokens: 0,
        responseTimes: [],
      };

      // Auto-resize textarea
      const messageInput = document.getElementById("messageInput");
      messageInput.addEventListener("input", function () {
        this.style.height = "auto";
        this.style.height = Math.min(this.scrollHeight, 120) + "px";
      });

      // Manejar selecci√≥n de archivo
      document.getElementById("imageInput").addEventListener("change", (e) => {
        const file = e.target.files[0];

        if (file) {
          selectedFile = file;

          // Mostrar preview
          const reader = new FileReader();
          reader.onload = function (event) {
            const preview = document.getElementById("imagePreview");
            const previewImg = document.getElementById("previewImg");
            previewImg.src = event.target.result;
            preview.style.display = "flex";
          };
          reader.readAsDataURL(file);
        }
      });

      // Bot√≥n para remover imagen
      document.getElementById("removeImage").addEventListener("click", () => {
        selectedFile = null;
        document.getElementById("imageInput").value = "";
        document.getElementById("imagePreview").style.display = "none";
      });

      function updateStats() {
        document.getElementById("totalMessages").textContent = stats.messages;
        document.getElementById("totalImages").textContent = stats.images;
        document.getElementById("totalTokens").textContent = stats.tokens;
        document.getElementById("messageCount").textContent =
          `${stats.messages} mensajes`;

        if (stats.responseTimes.length > 0) {
          const avg =
            stats.responseTimes.reduce((a, b) => a + b, 0) /
            stats.responseTimes.length;
          document.getElementById("avgResponseTime").textContent =
            `${Math.round(avg)}ms`;
        }
      }

      function addMessageToChat(
        role,
        content,
        hasImage = false,
        extractedText = null,
      ) {
        const chatHistory = document.getElementById("chatHistory");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${role} fade-in`;

        const icon = role === "user" ? "U" : "AI";
        const label = role === "user" ? "T√∫" : "Asistente";
        const time = new Date().toLocaleTimeString("es-ES", {
          hour: "2-digit",
          minute: "2-digit",
        });

        let imageTag = "";
        if (hasImage) {
          imageTag = '<div class="message-tag">Imagen analizada</div>';
        }

        let ocrSection = "";
        if (extractedText) {
          ocrSection = `
            <div class="ocr-result">
              <strong>Texto extra√≠do (OCR):</strong>
              <pre>${extractedText}</pre>
            </div>
          `;
        }

        messageDiv.innerHTML = `
          <div class="message-avatar">${icon}</div>
          <div class="message-content-wrapper">
            <div class="message-header">
              <strong>${label}</strong>
              <span class="timestamp">${time}</span>
            </div>
            ${imageTag}
            ${ocrSection}
            <div class="message-text">${content.replace(/\n/g, "<br>")}</div>
          </div>
        `;

        chatHistory.appendChild(messageDiv);
        chatHistory.scrollTop = chatHistory.scrollHeight;
      }

      // Enviar mensaje
      document
        .getElementById("chatForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const message = messageInput.value.trim();
          const sendBtn = document.getElementById("sendBtn");

          if (!message && !selectedFile) return;

          // Deshabilitar bot√≥n
          sendBtn.disabled = true;
          sendBtn.innerHTML =
            '<span class="send-icon spinning"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg></span>';

          const startTime = Date.now();

          // Mostrar mensaje del usuario
          addMessageToChat(
            "user",
            message || "(imagen sin texto)",
            !!selectedFile,
          );

          stats.messages++;
          if (selectedFile) stats.images++;
          updateStats();

          try {
            let imageBase64 = null;

            if (selectedFile) {
              imageBase64 = await new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(selectedFile);
              });
            }

            // En desarrollo local usa localhost:7071, en producci√≥n usa ruta relativa
            const apiUrl =
              window.location.hostname === "localhost" ||
              window.location.hostname === "127.0.0.1" ||
              window.location.hostname === "::1"
                ? "http://localhost:7071/api/agent"
                : "/api/agent";

            const response = await fetch(apiUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                message: message || "Analiza esta imagen",
                image: imageBase64,
                history: conversationHistory,
              }),
            });

            if (!response.ok) {
              throw new Error(`Error ${response.status}`);
            }

            const result = await response.json();

            if (result.success) {
              conversationHistory = result.history_updated;

              const responseTime = Date.now() - startTime;
              stats.responseTimes.push(responseTime);
              stats.tokens += 150; // Estimaci√≥n

              addMessageToChat(
                "assistant",
                result.reply,
                false,
                result.extracted_text,
              );
              updateStats();

              // Limpiar formulario
              messageInput.value = "";
              messageInput.style.height = "auto";
              selectedFile = null;
              document.getElementById("imageInput").value = "";
              document.getElementById("imagePreview").style.display = "none";
            } else {
              throw new Error(result.error || "Error desconocido");
            }
          } catch (error) {
            addMessageToChat("assistant", `Error: ${error.message}`);
          } finally {
            sendBtn.disabled = false;
            sendBtn.innerHTML =
              '<span class="send-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/></svg></span>';
          }
        });

      // Mensaje de bienvenida
      setTimeout(() => {
        addMessageToChat(
          "assistant",
          "Hola, soy tu asistente de Azure AI. Puedo analizar im√°genes con OCR y responder preguntas sobre Federico Zoppi utilizando RAG (Retrieval Augmented Generation). ¬øEn qu√© puedo ayudarte?",
        );
      }, 500);
    </script>
  </body>
</html>
