<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Portfolio Azure AI - Chat Inteligente</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="background-gradient"></div>

    <div class="container">
      <header class="header-glass">
        <h1>ğŸ¤– Azure AI Assistant</h1>
        <p class="subtitle">Computer Vision OCR + GPT-4.1-mini</p>
      </header>

      <!-- CHAT PRINCIPAL -->
      <div class="chat-container glass">
        <div class="chat-header">
          <div class="status-indicator">
            <span class="status-dot"></span>
            <span>En lÃ­nea</span>
          </div>
          <div class="stats-mini">
            <span id="messageCount">0 mensajes</span>
          </div>
        </div>

        <!-- Historial de conversaciÃ³n -->
        <div id="chatHistory" class="chat-history"></div>

        <!-- Formulario de entrada -->
        <form id="chatForm" class="chat-input-container">
          <div class="input-wrapper">
            <!-- Preview de imagen -->
            <div id="imagePreview" class="image-preview" style="display: none">
              <img id="previewImg" src="" alt="Preview" />
              <button type="button" id="removeImage" class="remove-image-btn">
                âœ•
              </button>
            </div>

            <!-- Ãrea de texto -->
            <textarea
              id="messageInput"
              placeholder="Escribe tu mensaje o adjunta una imagen..."
              rows="1"
            ></textarea>

            <!-- Botones de acciÃ³n -->
            <div class="input-actions">
              <label
                for="imageInput"
                class="attach-btn"
                title="Adjuntar imagen"
              >
                ğŸ“
              </label>
              <input
                type="file"
                id="imageInput"
                accept="image/*"
                style="display: none"
              />

              <button
                type="submit"
                id="sendBtn"
                class="send-btn"
                title="Enviar"
              >
                <span class="send-icon">ğŸ“¤</span>
              </button>
            </div>
          </div>
        </form>
      </div>

      <!-- ESTADÃSTICAS -->
      <div class="stats-container">
        <div class="stat-card glass">
          <div class="stat-icon">ğŸ’¬</div>
          <div class="stat-info">
            <span class="stat-value" id="totalMessages">0</span>
            <span class="stat-label">Mensajes</span>
          </div>
        </div>

        <div class="stat-card glass">
          <div class="stat-icon">ğŸ“·</div>
          <div class="stat-info">
            <span class="stat-value" id="totalImages">0</span>
            <span class="stat-label">ImÃ¡genes</span>
          </div>
        </div>

        <div class="stat-card glass">
          <div class="stat-icon">ğŸ”¤</div>
          <div class="stat-info">
            <span class="stat-value" id="totalTokens">0</span>
            <span class="stat-label">Tokens</span>
          </div>
        </div>

        <div class="stat-card glass">
          <div class="stat-icon">âš¡</div>
          <div class="stat-info">
            <span class="stat-value" id="avgResponseTime">0ms</span>
            <span class="stat-label">Tiempo promedio</span>
          </div>
        </div>
      </div>

      <!-- INFO DE SERVICIOS -->
      <div class="services-info glass">
        <h3>ğŸ”§ Servicios Azure Utilizados</h3>
        <div class="services-grid">
          <div class="service-badge">
            <span class="service-icon">ğŸ‘ï¸</span>
            <span>Computer Vision</span>
            <span class="badge-free">GRATIS</span>
          </div>
          <div class="service-badge">
            <span class="service-icon">ğŸ¤–</span>
            <span>Azure OpenAI</span>
            <span class="badge-cost">~$0.83/mes</span>
          </div>
          <div class="service-badge">
            <span class="service-icon">ğŸŒ</span>
            <span>Static Web Apps</span>
            <span class="badge-free">GRATIS</span>
          </div>
        </div>
      </div>
    </div>

    <script>
      let conversationHistory = [];
      let selectedFile = null;
      let stats = {
        messages: 0,
        images: 0,
        tokens: 0,
        responseTimes: [],
      };

      // Auto-resize textarea
      const messageInput = document.getElementById("messageInput");
      messageInput.addEventListener("input", function () {
        this.style.height = "auto";
        this.style.height = Math.min(this.scrollHeight, 120) + "px";
      });

      // Manejar selecciÃ³n de archivo
      document.getElementById("imageInput").addEventListener("change", (e) => {
        const file = e.target.files[0];

        if (file) {
          selectedFile = file;

          // Mostrar preview
          const reader = new FileReader();
          reader.onload = function (event) {
            const preview = document.getElementById("imagePreview");
            const previewImg = document.getElementById("previewImg");
            previewImg.src = event.target.result;
            preview.style.display = "flex";
          };
          reader.readAsDataURL(file);
        }
      });

      // BotÃ³n para remover imagen
      document.getElementById("removeImage").addEventListener("click", () => {
        selectedFile = null;
        document.getElementById("imageInput").value = "";
        document.getElementById("imagePreview").style.display = "none";
      });

      function updateStats() {
        document.getElementById("totalMessages").textContent = stats.messages;
        document.getElementById("totalImages").textContent = stats.images;
        document.getElementById("totalTokens").textContent = stats.tokens;
        document.getElementById("messageCount").textContent =
          `${stats.messages} mensajes`;

        if (stats.responseTimes.length > 0) {
          const avg =
            stats.responseTimes.reduce((a, b) => a + b, 0) /
            stats.responseTimes.length;
          document.getElementById("avgResponseTime").textContent =
            `${Math.round(avg)}ms`;
        }
      }

      function addMessageToChat(
        role,
        content,
        hasImage = false,
        extractedText = null,
      ) {
        const chatHistory = document.getElementById("chatHistory");
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${role} fade-in`;

        const icon = role === "user" ? "ğŸ‘¤" : "ğŸ¤–";
        const label = role === "user" ? "TÃº" : "Asistente";
        const time = new Date().toLocaleTimeString("es-ES", {
          hour: "2-digit",
          minute: "2-digit",
        });

        let imageTag = "";
        if (hasImage) {
          imageTag = '<div class="message-tag">ğŸ“· Imagen analizada</div>';
        }

        let ocrSection = "";
        if (extractedText) {
          ocrSection = `
            <div class="ocr-result">
              <strong>ğŸ“„ Texto extraÃ­do:</strong>
              <pre>${extractedText}</pre>
            </div>
          `;
        }

        messageDiv.innerHTML = `
          <div class="message-avatar">${icon}</div>
          <div class="message-content-wrapper">
            <div class="message-header">
              <strong>${label}</strong>
              <span class="timestamp">${time}</span>
            </div>
            ${imageTag}
            ${ocrSection}
            <div class="message-text">${content.replace(/\n/g, "<br>")}</div>
          </div>
        `;

        chatHistory.appendChild(messageDiv);
        chatHistory.scrollTop = chatHistory.scrollHeight;
      }

      // Enviar mensaje
      document
        .getElementById("chatForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const message = messageInput.value.trim();
          const sendBtn = document.getElementById("sendBtn");

          if (!message && !selectedFile) return;

          // Deshabilitar botÃ³n
          sendBtn.disabled = true;
          sendBtn.innerHTML = '<span class="send-icon spinning">â³</span>';

          const startTime = Date.now();

          // Mostrar mensaje del usuario
          addMessageToChat(
            "user",
            message || "(imagen sin texto)",
            !!selectedFile,
          );

          stats.messages++;
          if (selectedFile) stats.images++;
          updateStats();

          try {
            let imageBase64 = null;

            if (selectedFile) {
              imageBase64 = await new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(selectedFile);
              });
            }

            // En desarrollo local usa localhost:7071, en producciÃ³n usa ruta relativa
            const apiUrl =
              window.location.hostname === "localhost" ||
              window.location.hostname === "127.0.0.1" ||
              window.location.hostname === "::1"
                ? "http://localhost:7071/api/agent"
                : "/api/agent";

            const response = await fetch(apiUrl, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                message: message || "Analiza esta imagen",
                image: imageBase64,
                history: conversationHistory,
              }),
            });

            if (!response.ok) {
              throw new Error(`Error ${response.status}`);
            }

            const result = await response.json();

            if (result.success) {
              conversationHistory = result.history_updated;

              const responseTime = Date.now() - startTime;
              stats.responseTimes.push(responseTime);
              stats.tokens += 150; // EstimaciÃ³n

              addMessageToChat(
                "assistant",
                result.reply,
                false,
                result.extracted_text,
              );
              updateStats();

              // Limpiar formulario
              messageInput.value = "";
              messageInput.style.height = "auto";
              selectedFile = null;
              document.getElementById("imageInput").value = "";
              document.getElementById("imagePreview").style.display = "none";
            } else {
              throw new Error(result.error || "Error desconocido");
            }
          } catch (error) {
            addMessageToChat("assistant", `âŒ Error: ${error.message}`);
          } finally {
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<span class="send-icon">ğŸ“¤</span>';
          }
        });

      // Mensaje de bienvenida
      setTimeout(() => {
        addMessageToChat(
          "assistant",
          "Â¡Hola! Soy tu asistente de Azure AI. Puedo analizar imÃ¡genes con OCR y responder tus preguntas. Â¿En quÃ© puedo ayudarte?",
        );
      }, 500);
    </script>
  </body>
</html>
